{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Bosh AWS User & Groups",

  "Parameters": {
    "DeploymentName": {
      "Type": "String",
      "Description": "Deployment Name",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "^([A-Za-z0-9]+[A-Za-z0-9-]?)+[A-Za-z0-9]$",
      "ConstraintDescription": "Must be a valid domain label matching /^([A-Za-z0-9]+[A-Za-z0-9-])+[A-Za-z0-9]$/"
    }
  },

  "Outputs": {
    "BoshAwsAccessKeyId": {
      "Description": "ElastiCache Broker Access Key Id",
      "Value": { "Ref": "BoshAwsAccessKey" }
    },
    "BoshAwsSecretAccessKey": {
      "Description": "ElastiCache Broker Access Key",
      "Value": { "Fn::GetAtt": [ "BoshAwsAccessKey", "SecretAccessKey" ] }
    },
    "BoshAwsUserName": {
      "Description": "ElastiCache Broker User Name",
      "Value": { "Ref": "BoshAwsUser" }
    },
    "DeploymentIamGroup": {
      "Description": "Deployment IAM Group",
      "Value": { "Ref": "DeploymentIamGroup" },
      "Export": { "Name": { "Fn::Sub": "${DeploymentName}-DeploymentIamGroup" } }
    }
  },

  "Resources": {
    "DeploymentIamGroup": {
      "Type": "AWS::IAM::Group",
      "Properties": {
        "GroupName": { "Ref": "DeploymentName" },
        "Path": { "Fn::Sub": "/Cloudfoundry/Cloudformation/${DeploymentName}/" }
      }
    },

    "BoshAwsUser": {
      "Type": "AWS::IAM::User",
      "Properties": {
        "Groups": [
          { "Ref": "DeploymentIamGroup" }
        ],
        "Policies": [
          {
            "PolicyName": { "Fn::Sub": "${DeploymentName}-CfBoshAwsEc2Permissions" },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "ec2:*"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
                },
                {
                  "Action": [
                    "cloudwatch:*"
                  ],
                  "Effect": "Allow",
                  "Resource": { "Fn::Sub": "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:*" }
                },
                {
                  "Action": [
                    "elasticloadbalancing:*"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-ApplicationElb" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-ApplicationElbTargetGroup80Arn" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-ApplicationElbTargetGroup443Arn" } },
                    "*"
                  ]
                },
                {
                  "Action": [
                    "elasticloadbalancing:DescribeInstanceHealth",
                    "elasticloadbalancing:DescribeLoadBalancerAttributes",
                    "elasticloadbalancing:DescribeLoadBalancerPolicyTypes",
                    "elasticloadbalancing:DescribeLoadBalancers",
                    "elasticloadbalancing:DescribeLoadBalancerPolicies",
                    "elasticloadbalancing:DescribeTargetGroups",
                    "elasticloadbalancing:DescribeTags"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
                },
                {
                  "Action": [
                    "events:*"
                  ],
                  "Effect": "Allow",
                  "Resource": { "Fn::Sub": "arn:aws:events:${AWS::Region}:${AWS::AccountId}:*" }
                },
                {
                  "Action": [
                    "logs:*"
                  ],
                  "Effect": "Allow",
                  "Resource": { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*" }
                },
                {
                  "Action": [
                    "iam:GetUser"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
                },
                {
                  "Action": [
                    "iam:PassRole"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-BlobstoreBucketRoAccessRole" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-BlobstoreBucketRwAccessRole" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-CcBucketAccessRole" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-CompileNodesBucketAccessRole" } },
                    { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-DirectorBucketAccessRole" } }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "BoshAwsAccessKey": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "UserName": { "Ref": "BoshAwsUser" }
      }
    }
  }
}
