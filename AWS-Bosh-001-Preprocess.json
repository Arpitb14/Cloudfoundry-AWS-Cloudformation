{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Preprocessed values to work around missing AWS Cloudformation functionality",

  "Parameters": {
    "DeploymentName": {
      "Type": "String",
      "Description": "Deployment Name",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "^([A-Za-z0-9]+[A-Za-z0-9-]?)+[A-Za-z0-9]$",
      "ConstraintDescription": "Must be a valid domain label matching /^([A-Za-z0-9]+[A-Za-z0-9-])+[A-Za-z0-9]$/"
    },
    "StackDeleteAllowDeny": {
      "Type": "String",
      "Default": "Deny",
      "Description": "Deletion Policy Allow/Deny",
      "AllowedValues": [ "Allow", "Deny" ]
    },
    "StackUpdateAllowDeny": {
      "Type": "String",
      "Default": "Allow",
      "Description": "Update Policy Allow/Deny",
      "AllowedValues": [ "Allow", "Deny" ]
    },
    "MultiAz": {
      "Type": "String",
      "Default": "true",
      "Description": "Deploy multiple AZs",
      "AllowedValues": [ "true", "false" ]
    },
    "DeployElb": {
      "Type": "String",
      "Default": "true",
      "Description": "Deploy External ELB",
      "AllowedValues": [ "true", "false" ]
    },

    "DmzAz1Cidr": {
      "Type": "String",
      "Default": "10.0.10.0/24",
      "Description": "DMZ AZ1 CIDR - /24 to /27",
      "AllowedPattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/2(4|5|6|7)$",
      "ConstraintDescription": "Valid CIDR - /24 to /27"
    },
    "DmzAz2Cidr": {
      "Type": "String",
      "Default": "10.0.11.0/24",
      "Description": "DMZ AZ2 CIDR - /24 to /27",
      "AllowedPattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/2(4|5|6|7)$",
      "ConstraintDescription": "Valid CIDR - /24 to /27"
    }
  },

  "Outputs": {
    "DmzAz1Netmask": {
      "Description": "DMZ AZ1 Netmask",
      "Value": { "Fn::Select": [ "1", { "Fn::Split": [ "/", { "Ref": "DmzAz1Cidr" } ] } ] },
      "Export": { "Name": { "Fn::Sub": "${DeploymentName}-DmzAz1Netmask" } }
    },
    "DmzAz1Cidr4thOctet": {
      "Description": "DMZ AZ1 CIDR 4th Octet",
      "Value": { "Fn::Select": [ "0", { "Fn::Split": [ "/", { "Fn::Select": [ "3", { "Fn::Split": [ ".", { "Ref": "DmzAz1Cidr" } ] } ] } ] } ] },
      "Export": { "Name": { "Fn::Sub": "${DeploymentName}-DmzAz1Cidr4thOctet" } }
    },
    "DmzAz2Netmask": {
      "Description": "DMZ AZ2 Netmask",
      "Value": { "Fn::Select": [ "1", { "Fn::Split": [ "/", { "Ref": "DmzAz2Cidr" } ] } ] },
      "Export": { "Name": { "Fn::Sub": "${DeploymentName}-DmzAz2Netmask" } }
    },
    "DmzAz2Cidr4thOctet": {
      "Description": "DMZ AZ2 CIDR 4th Octet",
      "Value": { "Fn::Select": [ "0", { "Fn::Split": [ "/", { "Fn::Select": [ "3", { "Fn::Split": [ ".", { "Ref": "DmzAz2Cidr" } ] } ] } ] } ] },
      "Export": { "Name": { "Fn::Sub": "${DeploymentName}-DmzAz2Cidr4thOctet" } }
    }
  },

  "Conditions": {
    "MultiAzOrElb": {
      "Fn::Or": [
        { "Fn::Equals": [ { "Ref": "MultiAz" }, "true" ] },
        { "Fn::Equals": [ { "Ref": "DeployElb" }, "true" ] }
      ]
    }
  },

  "Resources": {
    "StackProtection": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "StackArn": { "Ref": "AWS::StackId" },
          "StackProtectionGroup": { "Ref": "StackProtectionGroup" },
          "StackDeleteAllowDeny": { "Ref": "StackDeleteAllowDeny" },
          "StackUpdateAllowDeny": { "Ref": "StackUpdateAllowDeny" }
        },
        "TemplateURL": {
          "Fn::Join": [
            "/", [
	      { "Fn::ImportValue": { "Fn::Sub": "${DeploymentName}-preamble-TemplatesBucketHttpUrl" } },
              "Templates",
              "Stack-Protection.json"
            ]
          ]
        }
      }
    }
  }
}
