{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Bosh - preamble",

  "Parameters": {
    "VpcPeerId1": {
      "Type": "String",
      "Default": "NONE",
      "Description": "VPC Peer ID 1",
      "AllowedPattern": "^vpc-[a-f0-9]{8}$",
      "ConstraintDescription": "Valid VPC ID"
    },
    "VpcPeerId2": {
      "Type": "String",
      "Default": "NONE",
      "Description": "VPC Peer ID 2",
      "AllowedPattern": "^vpc-[a-f0-9]{8}$",
      "ConstraintDescription": "Valid VPC ID"
    },
    "VpcCidrPeer1":
      "Type": "String",
      "Default": "127.0.0.0/8",
      "Description": "VPC Peer CIDR 1",
      "AllowedPattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
      "ConstraintDescription": "Valid CIDR"
    },
    "VpcCidrPeer2":
      "Type": "String",
      "Default": "127.0.0.0/8",
      "Description": "VPC Peer CIDR 2",
      "AllowedPattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
      "ConstraintDescription": "Valid CIDR"
    },
    "VpcCidrPeer1IpProtocol1": {
      "Type": "String",
      "Default": "tcp",
      "Description": "Whitelist VPC Peer Protocol 1 Egress",
      "AllowedValues": [ "tcp", "udp" ]
    },
    "VpcCidrPeer1IpProtocol2": {
      "Type": "String",
      "Default": "tcp",
      "Description": "Whitelist VPC Peer Protocol 2 Egress",
      "AllowedValues": [ "tcp", "udp" ]
    },
    "VpcCidrPeer1IpProtocol3": {
      "Type": "String",
      "Default": "tcp",
      "Description": "Whitelist VPC Peer Protocol 3 Egress",
      "AllowedValues": [ "tcp", "udp" ]
    },
    "VpcCidrPeer1IpProtocol4": {
      "Type": "String",
      "Default": "tcp",
      "Description": "Whitelist VPC Peer Protocol 4 Egress",
      "AllowedValues": [ "tcp", "udp" ]
    },
    "VpcCidrPeer1Port1": {
      "Type": "Number",
      "Default": "0",
      "Description": "Whitelist VPC Peer Port 1 Egress",
      "MinValue": "0",
      "MaxValue": "65535"
    },
    "VpcCidrPeer1Port2": {
      "Type": "Number",
      "Default": "0",
      "Description": "Whitelist VPC Peer Port 2 Egress",
      "MinValue": "0",
      "MaxValue": "65535"
    },
    "VpcCidrPeer1Port3": {
      "Type": "Number",
      "Default": "0",
      "Description": "Whitelist VPC Peer Port 3 Egress",
      "MinValue": "0",
      "MaxValue": "65535"
    },
    "VpcCidrPeer1Port4": {
      "Type": "Number",
      "Default": "0",
      "Description": "Whitelist VPC Peer Port 4 Egress",
      "MinValue": "0",
      "MaxValue": "65535"
    }
  },

  "Conditions": {
    "PeerVpc1": {
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId1" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1" }, "127.0.0.1" ] ] }
      ]
    },
    "PeerVpc2": {
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId2" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer2" }, "127.0.0.1" ] ] }
      ]
    },
    "WhitelistVpcCidrPeer1Port1": [
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId1" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1" }, "127.0.0.1" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1Port1" }, "0" ] ] }
      ]
    },
    "WhitelistVpcCidrPeer1Port2": [
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId1" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1" }, "127.0.0.1" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1Port2" }, "0" ] ] }
      ]
    },
    "WhitelistVpcCidrPeer1Port3": [
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId1" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1" }, "127.0.0.1" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1Port3" }, "0" ] ] }
      ]
    },
    "WhitelistVpcCidrPeer1Port4": [
      "Fn::And": [
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcPeerId1" }, "NONE" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1" }, "127.0.0.1" ] ] },
        { "Fn::Not": [ "Fn::Equals": [ { "Ref": "VpcCidrPeer1Port4" }, "0" ] ] }
      ]
    }
  },

  "Resources": {
    "VpcPeer1": {
      "Type" : "AWS::EC2::VPCPeeringConnection",
      "Condition": "PeerVpc1",
        "Properties" : {
          "PeerVpcId" : { "Ref": "VpcPeerId1" },
          "VpcId" : { "Ref": "CloudFoundryVpc" },
          "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${DeploymentName}:VpcPeer1" } } ]
        }
      }
    },
    "VpcPeer2": {
      "Type" : "AWS::EC2::VPCPeeringConnection",
      "Condition": "PeerVpc2",
        "Properties" : {
          "PeerVpcId" : { "Ref": "VpcPeerId1" },
          "VpcId" : { "Ref": "CloudFoundryVpc" },
          "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${DeploymentName}:VpcPeer2" } } ]
        }
      }
    },

    "PrivatePort1VpcCidrPeer1SecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Condition": "WhitelistVpcCidrPeer1Port1",
      "Properties": {
        "GroupId": { "Ref": "PrivateSecurityGroup" },
        "CidrIp": { "Ref": "VpcCidrPeer1" },
        "FromPort": { "Ref": "VpcCidrPeer1Port1" },
        "ToPort": { "Ref": "VpcCidrPeer1Port1" },
        "IpProtocol": { "Ref": "VpcCidrPeer1Protocol1" }
      }
    },
    "PrivatePort2VpcCidrPeer1SecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Condition": "WhitelistVpcCidrPeer1Port2",
      "Properties": {
        "GroupId": { "Ref": "PrivateSecurityGroup" },
        "CidrIp": { "Ref": "VpcCidrPeer1" },
        "FromPort": { "Ref": "VpcCidrPeer1Port2" },
        "ToPort": { "Ref": "VpcCidrPeer1Port2" },
        "IpProtocol": { "Ref": "VpcCidrPeer1Protocol2" }
      }
    },
    "PrivatePort3VpcCidrPeer1SecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Condition": "WhitelistVpcCidrPeer1Port3",
      "Properties": {
        "GroupId": { "Ref": "PrivateSecurityGroup" },
        "CidrIp": { "Ref": "VpcCidrPeer1" },
        "FromPort": { "Ref": "VpcCidrPeer1Port3" },
        "ToPort": { "Ref": "VpcCidrPeer1Port3" },
        "IpProtocol": { "Ref": "VpcCidrPeer1Protocol3" }
      }
    },
    "PrivatePort4VpcCidrPeer1SecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Condition": "WhitelistVpcCidrPeer1Port4",
      "Properties": {
        "GroupId": { "Ref": "PrivateSecurityGroup" },
        "CidrIp": { "Ref": "VpcCidrPeer1" },
        "FromPort": { "Ref": "VpcCidrPeer1Port4" },
        "ToPort": { "Ref": "VpcCidrPeer1Port4" },
        "IpProtocol": { "Ref": "VpcCidrPeer1Protocol4" }
      }
    }
  }
}
