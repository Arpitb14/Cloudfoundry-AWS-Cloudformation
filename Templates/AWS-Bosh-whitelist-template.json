{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Bosh - Firewall whitelist template",

  "Parameters": {
    "WhitelistName": {
      "Type": "String",
      "Description": "Whitelist name",
      "AllowedPattern": "^[A-Za-z0-9:]+$",
      "ConstraintDescription": "Alphanumeric string"
    },
    "WhitelistedCidr": {
      "Type": "String",
      "Default": "127.0.0.1/32",
      "Description": "CIDR to whitelist",
      "AllowedPattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
      "ConstraintDescription": "Valid CIDR"
    },
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID",
      "ConstraintDescription": "Valid VPC ID"
    }
  },

  "Outputs": {
    "ExternalSecurityGroup": {
      "Description": "External Security Group",
      "Value": { "Ref": "ExternalSecurityGroup" }
    },
    "PrivateSecurityGroup": {
      "Description": "Private Security Group",
      "Value": { "Ref": "PrivateSecurityGroup" }
    }
  },

  "Resources": {
    "ExternalSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "External In Out",
        "VpcId": { "Ref": "VpcId" },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                ":", [
                  { "Ref": "WhitelistName" },
                  "ExternalSecurityGroup"
                ]
              ]
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "ToPort": "65535",
            "IpProtocol": "-1"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": { "Ref": "WhitelistedCidr" },
            "FromPort": "80",
            "ToPort": "80" ,
            "IpProtocol": "tcp"
          },
          {
            "CidrIp": { "Ref": "WhitelistedCidr" },
            "FromPort": "443",
            "ToPort": "443" ,
            "IpProtocol": "tcp"
          }
        ]
      }
    },

    "PrivateSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Private In Out",
        "VpcId": { "Ref": "VpcId" },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                ":", [
                  { "Ref": "WhitelistName" },
                  "PrivateSecurityGroup"
                ]
              ]
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "ToPort": "65535",
            "IpProtocol": "-1"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": { "Ref": "WhitelistedCidr" },
            "FromPort": "22",
            "ToPort": "22" ,
            "IpProtocol": "tcp"
          },
          {
            "CidrIp": { "Ref": "WhitelistedCidr" },
            "FromPort": "6868",
            "ToPort": "6868" ,
            "IpProtocol": "tcp"
          },
          {
            "CidrIp": { "Ref": "WhitelistedCidr" },
            "FromPort": "25555",
            "ToPort": "25555" ,
            "IpProtocol": "tcp"
          }
        ]
      }
    }
  }
}
