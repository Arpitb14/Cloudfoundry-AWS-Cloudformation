{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Stack Protection",

  "Parameters": {
    "StackArn": {
      "Type": "String",
      "Description": "Stack ARN",
      "AllowedPattern": "^arn:aws::cloudformation:[a-z]+-[a-z]+-[0-9]+:[0-9]+:stack/[a-z0-9-]+/[0-9a-f]{8}-([0-9a-f]{4}-){2}[a-z0-9-]{12}$",
      "ConstraintDescription": "Must be a valid Cloudformation Stack ARN"
    },

    "StackProtectionGroup": {
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "128",
      "Description": "Stack protection group",
      "AllowedPattern": "^[A-Za-z0-9-]+$",
      "ConstraintDescription": "Can valid group name"
    },
    "StackDeleteAllowDeny": {
      "Type": "String",
      "Default": "Deny",
      "Description": "Deletion Policy Allow/Deny",
      "AllowedValues": [ "Allow", "Deny" ]
    },
    "StackUpdateAllowDeny": {
      "Type": "String",
      "Default": "Deny",
      "Description": "Update Policy Allow/Deny",
      "AllowedValues": [ "Allow", "Deny" ]
    }
  },

  "Resources": {
    "PreventStackDeletion": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "PreventStackDeletion",
        "Groups": [ { "Ref": "StackProtectionGroup" } ],
        "PolicyDocument": {
          "Version":"2012-10-17",
          "Statement": [
            {
              "Effect": { "Ref": "StackDeleteAllowDeny" },
              "Action": [
		"Delete:*",
		"cloudformation:DeleteStack"
              ],
              "Resource": { "Ref": "StackArn" }
            }
          ]
        }
      }
    },
    "PreventStackUpdate": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "PreventStackDeletion",
        "Groups": [ { "Ref": "StackProtectionGroup" } ],
        "PolicyDocument": {
          "Version":"2012-10-17",
          "Statement": [
            {
              "Effect": { "Ref": "StackUpdateAllowDeny" },
              "Action": [
		"Update:*",
		"cloudformation:UpdateStack"
              ],
              "Resource": { "Ref": "StackArn" }
            }
          ]
        }
      }
    }
  }
}
